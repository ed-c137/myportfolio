{"hash":"002060dd1693a13efb00c668dfa47c61ffb2282c","data":{"post":{"id":"c5a26749bc9358e01c8c40eefa52af82","title":"Testing Rails generators with ease.","content":"<p>Rails generator is a tool provided by the Rails\nframework to reduce the human effort of doing\nredundant manual things by automating the workflow.</p>\n<p>We use Rails generator all the time. Like, when you\nrun <code>rails new &#x3C;project_name></code> it behind the scenes\nuse Rails generator. Similarly, when you install a\nnew gem, some of the gems provide the generator to\nmake installation and configuring the gem easier.</p>\n<p>Refer: <a href=\"https://guides.rubyonrails.org/generators.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Creating and Customizing Rails Generators &#x26; Templates</a>\nguide to create generators.</p>\n<h4 id=\"problem-statement--motivation\"><a href=\"#problem-statement--motivation\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Problem statement &#x26; motivation</h4>\n<p>To install Action Text into the application,\nyou run <code>rails action_text:install</code>. The installer\nwas recently moved from Rails template to a generator.\nAfter moving to the generator we encountered some\nissues in the generator like:\n<a href=\"https://github.com/rails/rails/issues/39128\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">#39128</a>,\n<a href=\"https://github.com/rails/rails/pull/37823\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">#37823</a>,\n<a href=\"https://github.com/rails/rails/issues/40184\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">#40184</a>\nwhich weren't caught in the early stage of development.</p>\n<p>This was my motivation for looking into writing test cases\nfor Rails generator. PR: <a href=\"https://github.com/rails/rails/pull/39317\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">#39317</a></p>\n<p>Adding test cases for generators which normally\nonly creates a new file in the system are very easy.\nFor example, the migration generator.\nMigration generator adds a file called <code>db/&#x3C;timestamp>_name.rb</code>\nand test cases would assert the generation of the file.\nWriting test cases for generators which configures\nfiles into a Rails application was a bit of challenge\nuntil we explore that area.</p>\n<p>Let learn it with an example here. Let assume we are writing\na test case for a generator that adds Bootstrap in the application.\nThe generator would look something like:</p>\n<pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">module</span> <span class=\"token class-name\">Bootstrap</span>\n  <span class=\"token keyword\">module</span> <span class=\"token class-name\">Install</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">InstallGenerator</span> <span class=\"token operator\">&lt;</span> Rails<span class=\"token double-colon punctuation\">::</span>Generators<span class=\"token double-colon punctuation\">::</span>Base\n      desc <span class=\"token string-literal\"><span class=\"token string\">\"Adds Bootstrap to the application\"</span></span>\n      source_root <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>expand_path<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"templates\"</span></span><span class=\"token punctuation\">,</span> __dir__<span class=\"token punctuation\">)</span>\n\n      <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">add_bootstrap_package</span></span>\n        say <span class=\"token string-literal\"><span class=\"token string\">\"Adding bootstrap packages\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:green</span>\n        run <span class=\"token string-literal\"><span class=\"token string\">\"yarn add bootstrap jquery popper.js\"</span></span>\n      <span class=\"token keyword\">end</span>\n\n      <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">import_bootstrap_stylesheet_in_application_scss</span></span>\n        <span class=\"token operator\">...</span>\n      <span class=\"token keyword\">end</span>\n\n      <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">import_bootstrap_javascript_in_application_js</span></span>\n        <span class=\"token operator\">...</span>\n      <span class=\"token keyword\">end</span>\n\n      <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n<p>To add Bootstrap in the application you require\nfollowing files and these needs to be present when\nBootstrap generator runs in the test cases.</p>\n<ul>\n<li><code>package.json</code> to install NPM package.</li>\n<li>Webpacker configured.</li>\n<li><code>application.js</code> bundled via webpack.</li>\n<li><code>application.scss</code> bundled via webpack.</li>\n</ul>\n<pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">\"test_helper\"</span></span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BootstrapInstallGeneratorTest</span> <span class=\"token operator\">&lt;</span> Rails<span class=\"token double-colon punctuation\">::</span>Generators<span class=\"token double-colon punctuation\">::</span>TestCase\n  destination <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>expand_path<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"../tmp\"</span></span><span class=\"token punctuation\">,</span> __dir__<span class=\"token punctuation\">)</span>\n  setup <span class=\"token symbol\">:prepare_destination</span>\n  tests Bootstrap<span class=\"token double-colon punctuation\">::</span>Install<span class=\"token double-colon punctuation\">::</span>InstallGenerator\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">test_should_add_bootstrap_npm_package</span></span>\n    run_generator\n\n    assert_file <span class=\"token string-literal\"><span class=\"token string\">\"package.json\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>content<span class=\"token operator\">|</span>\n      assert_match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/popper/</span></span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\n      assert_match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/bootstrap/</span></span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\n      assert_match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/jquery/</span></span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n<p>Running the above test cases will fail with\nfollowing error:</p>\n<pre class=\"language-ruby\"><code class=\"language-ruby\">Expected file <span class=\"token string-literal\"><span class=\"token string\">\"package.json\"</span></span> to exist<span class=\"token punctuation\">,</span> but does <span class=\"token keyword\">not</span></code></pre>\n<p>To tackle this problem we will create a\nsimple Rails application on setup and run\nthe generator within the dummy application.</p>\n<ul>\n<li>Add a simple Rails application in the template:\n<code>tmp/templates/app_template</code>.</li>\n<li>Add a generator helper that would build the application\non setup. The helper has <code>build_app</code> helper method\nwhich copies the Rails template app in the temp directory.\nThe generator also defines some path helper methods to\neasily find the application, app_template.</li>\n</ul>\n<pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">ROOT_PATH</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>expand_path<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"../\"</span></span><span class=\"token punctuation\">,</span> __dir__<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">module</span> <span class=\"token class-name\">GeneratorHelper</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">app_template_path</span></span>\n    <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>join <span class=\"token constant\">ROOT_PATH</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">\"tmp/templates/app_template\"</span></span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">tmp_path</span></span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span>\n    <span class=\"token variable\">@tmp_path</span> <span class=\"token operator\">||=</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>realpath<span class=\"token punctuation\">(</span><span class=\"token builtin\">Dir</span><span class=\"token punctuation\">.</span>mktmpdir<span class=\"token punctuation\">(</span><span class=\"token keyword\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token constant\">ROOT_PATH</span><span class=\"token punctuation\">,</span> <span class=\"token string-literal\"><span class=\"token string\">\"tmp\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token builtin\">File</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token variable\">@tmp_path</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">app_path</span></span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span>\n    path <span class=\"token operator\">=</span> tmp_path<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token string-literal\"><span class=\"token string\">%w[app]</span></span> <span class=\"token operator\">+</span> args<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> block_given<span class=\"token operator\">?</span>\n      <span class=\"token keyword\">yield</span> path\n    <span class=\"token keyword\">else</span>\n      path\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">build_app</span></span>\n    FileUtils<span class=\"token punctuation\">.</span>rm_rf<span class=\"token punctuation\">(</span>app_path<span class=\"token punctuation\">)</span>\n    FileUtils<span class=\"token punctuation\">.</span>cp_r<span class=\"token punctuation\">(</span>app_template_path<span class=\"token punctuation\">,</span> app_path<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">teardown_app</span></span>\n    FileUtils<span class=\"token punctuation\">.</span>rm_rf<span class=\"token punctuation\">(</span>tmp_path<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n<ul>\n<li>Now the last thing to do is update the test cases\nto setup the application and run generator within the\napplication namespace.</li>\n</ul>\n<pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string-literal\"><span class=\"token string\">\"test_helper\"</span></span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BootstrapInstallGeneratorTest</span> <span class=\"token operator\">&lt;</span> Rails<span class=\"token double-colon punctuation\">::</span>Generators<span class=\"token double-colon punctuation\">::</span>TestCase\n  <span class=\"token keyword\">include</span> GeneratorHelper\n\n  tests Bootstrap<span class=\"token double-colon punctuation\">::</span>Install<span class=\"token double-colon punctuation\">::</span>InstallGenerator\n  setup <span class=\"token symbol\">:build_app</span>\n  teardown <span class=\"token symbol\">:teardown_app</span>\n\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">test_should_add_bootstrap_npm_package</span></span>\n    <span class=\"token builtin\">Dir</span><span class=\"token punctuation\">.</span>chdir<span class=\"token punctuation\">(</span>app_path<span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n      run_generator\n\n      assert_file <span class=\"token string-literal\"><span class=\"token string\">\"package.json\"</span></span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>content<span class=\"token operator\">|</span>\n        assert_match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/popper/</span></span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\n        assert_match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/bootstrap/</span></span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\n        assert_match<span class=\"token punctuation\">(</span><span class=\"token regex-literal\"><span class=\"token regex\">/jquery/</span></span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">end</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre>\n<p>Voila. The test cases for Bootstrap generator should be passing now.</p>\n<p><strong>Happy Coding!!</strong></p>\n","date":"October 30, 2020","tags":[]}},"context":{}}